generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String         @id @default(uuid()) @db.Uuid
  email      String         @unique
  name       String?
  createdAt  DateTime       @default(now()) @map("created_at")
  updatedAt  DateTime       @updatedAt @map("updated_at")
  patients   Patient[]      @relation("PatientCreatedBy")
  facilities UserFacility[]
  photos     Photo[]        @relation("PhotoUploadedBy")

  @@map("users")
}

model Facility {
  id            String         @id @default(uuid()) @db.Uuid
  name          String
  address       String?
  city          String?
  state         String?
  zip           String?
  phone         String?
  fax           String?
  contactPerson String?        @map("contact_person")
  email         String?
  notes         String?
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  patients      Patient[]
  users         UserFacility[]

  @@map("facilities")
}

model UserFacility {
  userId     String   @map("user_id") @db.Uuid
  facilityId String   @map("facility_id") @db.Uuid
  isDefault  Boolean  @default(false) @map("is_default")
  createdAt  DateTime @default(now()) @map("created_at")
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, facilityId])
  @@map("user_facilities")
}

model Patient {
  id               String    @id @default(uuid()) @db.Uuid
  facilityId       String    @map("facility_id") @db.Uuid
  firstName        String    @map("first_name")
  lastName         String    @map("last_name")
  dob              DateTime  @db.Date
  mrn              String
  gender           String?
  phone            String?
  email            String?
  address          String?
  city             String?
  state            String?
  zip              String?
  insuranceInfo    Json?     @map("insurance_info")
  emergencyContact Json?     @map("emergency_contact")
  allergies        Json?
  medicalHistory   Json?     @map("medical_history")
  isActive         Boolean   @default(true) @map("is_active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  createdBy        String    @map("created_by") @db.Uuid
  billings         Billing[]
  creator          User      @relation("PatientCreatedBy", fields: [createdBy], references: [id])
  facility         Facility  @relation(fields: [facilityId], references: [id])
  visits           Visit[]
  wounds           Wound[]

  @@unique([facilityId, mrn])
  @@index([facilityId])
  @@index([lastName, firstName])
  @@map("patients")
}

model Wound {
  id          String       @id @default(uuid()) @db.Uuid
  patientId   String       @map("patient_id") @db.Uuid
  woundNumber String       @map("wound_number")
  location    String
  woundType   String       @map("wound_type")
  onsetDate   DateTime     @map("onset_date") @db.Date
  status      String       @default("active")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  assessments Assessment[]
  photos      Photo[]
  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([status])
  @@map("wounds")
}

model Visit {
  id              String       @id @default(uuid()) @db.Uuid
  patientId       String       @map("patient_id") @db.Uuid
  visitDate       DateTime     @map("visit_date")
  visitType       String       @map("visit_type")
  location        String?
  status          String       @default("incomplete")
  numberOfAddenda Int          @default(0) @map("number_of_addenda")
  followUpType    String?      @map("follow_up_type")
  followUpDate    DateTime?    @map("follow_up_date")
  followUpNotes   String?      @map("follow_up_notes")
  timeSpent       Boolean      @default(false) @map("time_spent")
  additionalNotes String?      @map("additional_notes")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  assessments     Assessment[]
  billings        Billing[]
  treatments      Treatment[]
  photos          Photo[]
  patient         Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([visitDate])
  @@map("visits")
}

model Assessment {
  id                 String   @id @default(uuid()) @db.Uuid
  visitId            String   @map("visit_id") @db.Uuid
  woundId            String   @map("wound_id") @db.Uuid
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")
  woundType          String?  @map("wound_type")
  pressureStage      String?  @map("pressure_stage")
  healingStatus      String?  @map("healing_status")
  atRiskReopening    Boolean? @map("at_risk_reopening")
  length             Decimal? @db.Decimal(5, 2)
  width              Decimal? @db.Decimal(5, 2)
  depth              Decimal? @db.Decimal(5, 2)
  area               Decimal? @db.Decimal(7, 2)
  undermining        String?
  tunneling          String?
  epithelialPercent  Int?     @map("epithelial_percent")
  granulationPercent Int?     @map("granulation_percent")
  sloughPercent      Int?     @map("slough_percent")
  exudateAmount      String?  @map("exudate_amount")
  exudateType        String?  @map("exudate_type")
  odor               String?
  periwoundCondition String?  @map("periwound_condition")
  painLevel          Int?     @map("pain_level")
  infectionSigns     Json?    @map("infection_signs")
  assessmentNotes    String?  @map("assessment_notes")
  visit              Visit    @relation(fields: [visitId], references: [id], onDelete: Cascade)
  wound              Wound    @relation(fields: [woundId], references: [id], onDelete: Cascade)
  photos             Photo[]

  @@index([visitId])
  @@index([woundId])
  @@map("assessments")
}

model Treatment {
  id                  String   @id @default(uuid()) @db.Uuid
  visitId             String   @map("visit_id") @db.Uuid
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  primaryDressings    Json?    @map("primary_dressings")
  secondaryDressings  Json?    @map("secondary_dressings")
  antimicrobials      Json?
  debridement         Json?
  advancedTherapies   Json?    @map("advanced_therapies")
  compression         Json?
  moistureManagement  Json?    @map("moisture_management")
  npwtPressure        Int?     @map("npwt_pressure")
  npwtFrequency       String?  @map("npwt_frequency")
  preventiveOrders    Json?    @map("preventive_orders")
  chairCushionType    String?  @map("chair_cushion_type")
  frequencyDays       Int?     @map("frequency_days")
  prn                 Boolean  @default(false)
  treatmentOrders     String?  @map("treatment_orders")
  specialInstructions String?  @map("special_instructions")
  visit               Visit    @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([visitId])
  @@map("treatments")
}

model Photo {
  id           String      @id @default(uuid()) @db.Uuid
  woundId      String      @map("wound_id") @db.Uuid
  visitId      String?     @map("visit_id") @db.Uuid
  assessmentId String?     @map("assessment_id") @db.Uuid
  uploadedBy   String      @map("uploaded_by") @db.Uuid
  url          String      // Supabase Storage URL
  filename     String      @map("file_name")
  fileSize     Int         @map("file_size")
  mimeType     String      @map("mime_type")
  thumbnailUrl String?     @map("thumbnail_url")
  caption      String?     @db.Text
  uploadedAt   DateTime    @default(now()) @map("uploaded_at")
  
  // Relations
  wound      Wound       @relation(fields: [woundId], references: [id], onDelete: Cascade)
  visit      Visit?      @relation(fields: [visitId], references: [id], onDelete: SetNull)
  assessment Assessment? @relation(fields: [assessmentId], references: [id], onDelete: SetNull)
  uploader   User        @relation("PhotoUploadedBy", fields: [uploadedBy], references: [id])

  @@index([woundId])
  @@index([visitId])
  @@index([assessmentId])
  @@index([uploadedBy])
  @@map("photos")
}

model Billing {
  id         String   @id @default(uuid()) @db.Uuid
  visitId    String   @map("visit_id") @db.Uuid
  patientId  String   @map("patient_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  cptCodes   Json     @map("cpt_codes")
  icd10Codes Json     @map("icd10_codes")
  modifiers  Json?
  timeSpent  Boolean  @default(false) @map("time_spent")
  notes      String?
  patient    Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  visit      Visit    @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([visitId])
  @@index([patientId])
  @@map("billings")
}
